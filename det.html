<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <input type="text">
    <button type="submit" id="btn" name="btn">Click!</button>
    <br>
    <textarea rows="20" cols="50" onkeydown="onKeyD(event)" onkeypress="onKeyP(event)" id="icht">
    </textarea> 
    <script>
        document.getElementById('btn').addEventListener("click",onCallFunc);
        function onCallFunc(){
            document.getElementById('icht').value = '';
            window.setTimeout(edit,50);
        }
        function alrt(){
            alert('merge');
        }
        function onKeyP(e){
            // alert(String.fromCharCode(e.keyCode));
            var pos = document.getElementById('icht').selectionStart;
            fetch('/apiDet.php',{
                method: 'POST',
                body: JSON.stringify({a:String.fromCharCode(e.keyCode),b:pos}),
                headers: {'Content-type':'Text'}
            })
            .then(function(response){
                return response.text();
            })
            .then(function(myData){
                //console.log(myData);
            });
            // .then(function(myData){
            //     document.getElementById('icht').innerHTML = myData;
            // })
            // .then(function(response){
            //     return response.text();
            // })
            // .then(function(myData){
            //     alert(myData);
            // })
        }
        var el = document.getElementById('icht').value;
        // setInterval(function edit(){
        //     fetch('/apiDet.php',{
        //         method:'GET'
        //     })
        //     .then(function(response){
        //         return response.text();
        //     })
        //     .then(function(myData){
        //         if(myData !== document.getElementById('icht').value)
        //             document.getElementById('icht').innerHTML = myData;
        //     })
        // },30);
        function edit(){
            var pos = document.getElementById('icht').selectionStart;
            var pos2 = document.getElementById('icht').selectionEnd;
            fetch('/apiDet.php',{
                method:'GET'
            })
            .then(function(response){
                return response.text();
            })
            .then(function(myData){
                var str = String(document.getElementById('icht').value);
                var str2 = String(myData);
                if(str.length !== str2.length){
                    document.getElementById('icht').value = str2;
                }
            })
            document.getElementById('icht').selectionStart = pos;
            document.getElementById('icht').selectionEnd = pos2;
            var t = window.setTimeout(edit,50);   
        }
        function onKeyD(e){
            var pos = document.getElementById('icht').selectionStart;
            if(e.keyCode === 8){
                // alert('backspace');
                var info = 'backspace';
                fetch('/apiDet.php',{
                    method: 'POST',
                    body: JSON.stringify({a:info,b:pos}),
                    headers: {'Content-type':'Text'}
                })
                // .then(function(response){
                // return response.text();
                // })
                // .then(function(myData){
                // alert(myData);
                // })
            }
            document.getElementById('icht').selectionStart = pos;
        }
    </script>
</body>
</html>